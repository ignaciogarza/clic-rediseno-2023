<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iscreammedia.clic.front.repository.MypageRepository">	
	
	<select id="selectCommunityList" parameterType="map" resultType="com.iscreammedia.clic.front.domain.CommunityDomain">
		/* 스킬 인증 완료 */
		SELECT		/* MypageRepository.selectCommunityList 커뮤니티 조회 */
			USER_ID
			, NAME
			, FIRSTNAME
			, USER_IMAGE_PATH
			, JOB_NAME
			, FRIEND_ID
			, SKILL_CODE
			, EXAM_CLASS_CODE
			, SKILL_NAME
			, USE_IF
			, CREATED_DATE
			, COUNTRY_CODE
		FROM
		(SELECT
			B.USER_ID
			, A.NAME
			, A.FIRSTNAME
			, A.USER_IMAGE_PATH
			, (SELECT JOB_NAME_${language.code} FROM T_JOB_TABLE C WHERE A.JOB_ID = C.JOB_ID) JOB_NAME
			, B.FRIEND_ID
			, B.SKILL_CODE
			, B.EXAM_CLASS_CODE
			, S.SKILL_NAME_${language.code} AS SKILL_NAME
			, B.IS_AUTH AS USE_IF
			, B.UPDATED_DATE AS CREATED_DATE
			, CT.COUNTRY_CODE
		FROM T_USER A
		JOIN T_SKILL_FRIEND_AUTH B ON A.USER_ID = B.FRIEND_ID
		JOIN T_USER U ON U.USER_ID = A.USER_ID
		LEFT JOIN T_COUNTRY_TABLE CT ON CT.COUNTRY_CODE = U.COUNTRY_CODE
		JOIN T_SKILL S ON S.SKILL_CODE = B.SKILL_CODE
			AND S.EXAM_CLASS_CODE = B.EXAM_CLASS_CODE
		WHERE B.USER_ID = #{userId}
			AND B.IS_AUTH = 'Y'
		UNION ALL
		/* 스킬 인증 요청 */
		SELECT
			A.USER_ID
			, A.NAME
			, A.FIRSTNAME
			, A.USER_IMAGE_PATH
			, (SELECT JOB_NAME_${language.code} FROM T_JOB_TABLE C WHERE A.JOB_ID = C.JOB_ID) JOB_NAME
			, B.FRIEND_ID
			, B.SKILL_CODE
			, B.EXAM_CLASS_CODE
			, S.SKILL_NAME_${language.code} AS SKILL_NAME
			, B.IS_AUTH AS USE_IF
			, B.AUTH_REQUEST_DATE AS CREATED_DATE
			, CT.COUNTRY_CODE
		FROM T_USER A
		JOIN T_SKILL_FRIEND_AUTH B ON A.USER_ID = B.USER_ID
		JOIN T_USER U ON U.USER_ID = B.USER_ID
		LEFT JOIN T_COUNTRY_TABLE CT ON CT.COUNTRY_CODE = U.COUNTRY_CODE
		JOIN T_SKILL S ON S.SKILL_CODE = B.SKILL_CODE
			AND S.EXAM_CLASS_CODE = B.EXAM_CLASS_CODE
		WHERE B.FRIEND_ID = #{userId}
			AND B.IS_AUTH = 'R'
		UNION ALL
		/* 친구 요청 */
		SELECT
			A.USER_ID
			, A.NAME
			, A.FIRSTNAME
			, A.USER_IMAGE_PATH
			, (SELECT JOB_NAME_${language.code} FROM T_JOB_TABLE C WHERE A.JOB_ID = C.JOB_ID) JOB_NAME
			, B.FRIEND_ID
			, NULL AS SKILL_CODE
			, NULL AS EXAM_CLASS_CODE
    		, NULL AS SKILL_NAME
			, B.FRIEND_STATUS_CODE AS USE_IF
			, B.CREATED_DATE AS CREATED_DATE
			, CT.COUNTRY_CODE
		FROM T_USER A
		JOIN T_FRIEND B ON A.USER_ID = B.USER_ID
		JOIN T_USER U ON U.USER_ID = B.USER_ID
		LEFT JOIN T_COUNTRY_TABLE CT ON CT.COUNTRY_CODE = U.COUNTRY_CODE
		WHERE B.FRIEND_ID = #{userId}
			AND B.FRIEND_STATUS_CODE = '1101') A
		ORDER BY CREATED_DATE DESC
		OFFSET #{startIndex} ROW
		FETCH NEXT #{rows} ROW ONLY
	</select>
	
	<select id="selectSkillList" parameterType="map" resultType="com.iscreammedia.clic.front.domain.Skill">
		SELECT		/* MypageRepository.selectSkillList 뱃지 조회 */
			S.SKILL_CODE
			, SPS.USER_ID
			, S.EXAM_CLASS_CODE
			, S.SKILL_NAME_${language.code} AS SKILL_NAME
			, S.SKILL_IMAGE_PATH
			, S.BADGE_OBTAIN_LEVEL_CODE
			, ISNULL(HS.SKILL_PROGRESS_LEVEL_CODE, '1201') AS SKILL_PROGRESS_LEVEL_CODE
			, ISNULL(SPS.EXAM_PROGRESS_STATUS_CODE, '1401') AS EXAM_PROGRESS_STATUS_CODE
			, CASE
				WHEN ISNULL(HS.SKILL_PROGRESS_LEVEL_CODE, '1201') = '1201' THEN 'NOT_TESTED'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1205'                 THEN 'PASS'
				/* SELF_EXAM */
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1401' THEN 'SELF_EXAM_WAIT'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1402' THEN 'SELF_EXAM_TAKING'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1403' THEN 'SELF_EXAM_TIME_OUT'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1404' THEN 'SELF_EXAM_FAILED'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1405' THEN 'SELF_EXAM_PASS'
				/* SKILL_EXAM */
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1203' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1401' THEN 'SKILL_EXAM_WAIT'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1203' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1402' THEN 'SKILL_EXAM_TAKING'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1203' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1403' THEN 'SKILL_EXAM_TIME_OUT'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1203' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1404' THEN 'SKILL_EXAM_FAILED'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1203' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1405' THEN 'SKILL_EXAM_PASS'
				/* FRIEND_AUTH */
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1204' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1401' THEN 'FRIEND_AUTH_WAIT'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1204' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1402' THEN 'FRIEND_AUTH_TAKING'
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1204' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1405' THEN 'FRIEND_AUTH_PASS'
			END AS PROGRESS_STATUS_CODE
			, B.BADGE_ID
			, B.BADGE_NAME_${language.code} AS BADGE_NAME
			, B.BADGE_DEFAULT_IMAGE_PATH_${language.code} AS BADGE_DEFAULT_IMAGE_PATH
			, B.BADGE_OBTAIN_IMAGE_PATH_${language.code} AS BADGE_OBTAIN_IMAGE_PATH
			, CASE
				WHEN HS.SKILL_PROGRESS_LEVEL_CODE = '1205' THEN 1
				WHEN NOT HS.SKILL_PROGRESS_LEVEL_CODE = '1205' 
					AND NOT HS.SKILL_PROGRESS_LEVEL_CODE = '1201'
					AND NOT (HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1401') THEN 2
				ELSE 3
			END SKILL_ORDER
		FROM T_SKILL S
		LEFT JOIN 
			T_SKILL_PROGRESS_STATUS SPS
				ON SPS.SKILL_CODE = S.SKILL_CODE
				AND SPS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
				AND SPS.USER_ID = #{userId}
		LEFT JOIN
			T_HAVE_SKILL HS
				ON HS.SKILL_CODE = S.SKILL_CODE
				AND HS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
				AND HS.USER_ID = SPS.USER_ID
		LEFT JOIN T_BADGE B ON B.BADGE_ID = S.BADGE_ID
		WHERE S.IS_USE = 'Y'
		ORDER BY SKILL_ORDER, BADGE_NAME
	</select>
	
	<select id="selfCount" parameterType="String" resultType="int">
		SELECT		/* MypageRepository.selfCount 자기 인증 완료 수 */
			COUNT(S.SKILL_CODE)
		FROM T_SKILL S
		JOIN T_HAVE_SKILL HS ON HS.SKILL_CODE = S.SKILL_CODE
			AND HS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND HS.USER_ID = #{userId}
		JOIN T_SKILL_PROGRESS_STATUS SPS ON SPS.SKILL_CODE = S.SKILL_CODE
			AND SPS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND SPS.USER_ID = HS.USER_ID
		WHERE S.IS_USE = 'Y'
			AND (HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1405'
				OR HS.SKILL_PROGRESS_LEVEL_CODE = '1203'
				OR HS.SKILL_PROGRESS_LEVEL_CODE = '1204'
				OR HS.SKILL_PROGRESS_LEVEL_CODE = '1205')
	</select>
	
	<select id="examCount" parameterType="String" resultType="int">
		SELECT		/* MypageRepository.examCount 기술 테스트 완료 수 */
			COUNT(S.SKILL_CODE)
		FROM T_SKILL S
		JOIN T_HAVE_SKILL HS ON HS.SKILL_CODE = S.SKILL_CODE
			AND HS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND HS.USER_ID = #{userId}
		JOIN T_SKILL_PROGRESS_STATUS SPS ON SPS.SKILL_CODE = S.SKILL_CODE
			AND SPS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND SPS.USER_ID = HS.USER_ID
		WHERE S.IS_USE = 'Y'
			AND S.BADGE_OBTAIN_LEVEL_CODE NOT IN ('1501', '1504')
			AND (HS.SKILL_PROGRESS_LEVEL_CODE = '1203' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1405'
				OR HS.SKILL_PROGRESS_LEVEL_CODE = '1204'
				OR HS.SKILL_PROGRESS_LEVEL_CODE = '1205')
	</select>
	
	<select id="friendCount" parameterType="String" resultType="int">
		SELECT		/* MypageRepository.friendCount 친구 인증 완료 수 */
			COUNT(S.SKILL_CODE)
		FROM T_SKILL S
		JOIN T_SKILL_FRIEND_AUTH SFA ON SFA.SKILL_CODE = S.SKILL_CODE
			AND SFA.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
		WHERE SFA.USER_ID = #{userId}
			AND SFA.IS_AUTH = 'Y' 
	</select>
	
	<select id="badgeGetCount" parameterType="String" resultType="int">
		SELECT		/* MypageRepository.badgeGetCount 획득한 뱃지 수 */
			COUNT(S.SKILL_CODE)
		FROM T_SKILL S
		JOIN T_SKILL_PROGRESS_STATUS SPS
			ON	SPS.SKILL_CODE = S.SKILL_CODE
			AND SPS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND SPS.USER_ID = #{userId}
		JOIN T_HAVE_SKILL HS
			ON	HS.SKILL_CODE = S.SKILL_CODE
			AND HS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND HS.USER_ID = SPS.USER_ID
		WHERE S.IS_USE = 'Y'
			AND HS.SKILL_PROGRESS_LEVEL_CODE = '1205'
	</select>
	
	<select id="testCk" parameterType="String" resultType="int">
		SELECT		/* MypageRepository.testCk 테스트 진행 내역 체크 */
			COUNT(DISTINCT S.SKILL_CODE) AS COUNT
		FROM T_SKILL S
		JOIN T_SKILL_PROGRESS_STATUS SPS
			ON	SPS.SKILL_CODE = S.SKILL_CODE
			AND SPS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND SPS.USER_ID = #{userId}
		JOIN T_HAVE_SKILL HS
			ON	HS.SKILL_CODE = S.SKILL_CODE
			AND HS.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
			AND HS.USER_ID = SPS.USER_ID
		JOIN T_SKILL_EDUCATION_MAPPING SEM ON SEM.SKILL_CODE = S.SKILL_CODE
			AND SEM.EXAM_CLASS_CODE = S.EXAM_CLASS_CODE
		WHERE S.IS_USE = 'Y'
			AND NOT HS.SKILL_PROGRESS_LEVEL_CODE = '1201'
			AND NOT (HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1401')
	</select>
	
	<select id="selectNoDataEduList" parameterType="map" resultType="com.iscreammedia.clic.front.domain.SkillEducationDomain">
		SELECT		/*	MypageRepository.selectNoDataEduList  테스트 진행 내역이 없는 경우 - 교육 조회*/
			SE.SKILL_EDUCATION_ID
			, SE.TITLE_${language.code} AS TITLE
			, SE.CONTENTS_${language.code} AS CONTENTS
			, SE.IMAGE_PATH
			, SE.EDUCATION_PC_URL
			, SE.EDUCATION_MOBILE_URL
			, SE.EDUCATION_ORGANIZATION
			, SE.EDUCATION_PERIOD
			, CASE
				CAST(SE.EDUCATION_COAST AS NVARCHAR) WHEN '0' THEN 'FREE'
				ELSE CAST(SE.EDUCATION_COAST AS NVARCHAR)
			END AS EDUCATION_COAST
			, SE.IS_USE
		FROM T_SKILL_EDUCATION SE
		JOIN (
			SELECT
				SEM.SKILL_EDUCATION_ID
			FROM T_SKILL_EDUCATION_MAPPING SEM
			JOIN T_SKILL S ON S.SKILL_CODE = SEM.SKILL_CODE
				AND S.EXAM_CLASS_CODE = SEM.EXAM_CLASS_CODE
			WHERE S.IS_USE = 'Y'
			GROUP BY SEM.SKILL_EDUCATION_ID
		) JSEM ON JSEM.SKILL_EDUCATION_ID = SE.SKILL_EDUCATION_ID
		WHERE SE.IS_USE = 'Y'
		ORDER BY NEWID()
		OFFSET 0 ROW
		FETCH NEXT #{rows} ROW ONLY
	</select>
	
	<select id="selectDataEduList" parameterType="map" resultType="com.iscreammedia.clic.front.domain.SkillEducationDomain">
		SELECT		/*	MypageRepository.selectDataEduList  테스트 진행 내역이 있는 경우 - 교육 조회*/
			SE.SKILL_EDUCATION_ID
			, SE.TITLE_${language.code} AS TITLE
			, SE.CONTENTS_${language.code} AS CONTENTS
			, SE.IMAGE_PATH
			, SE.EDUCATION_PC_URL
			, SE.EDUCATION_MOBILE_URL
			, SE.EDUCATION_ORGANIZATION
			, SE.EDUCATION_PERIOD
			, CASE
				CAST(SE.EDUCATION_COAST AS NVARCHAR) WHEN '0' THEN 'FREE'
				ELSE CAST(SE.EDUCATION_COAST AS NVARCHAR)
			END AS EDUCATION_COAST
			, SE.IS_USE
		FROM T_SKILL_EDUCATION SE
		JOIN (
			SELECT
				SEM.SKILL_EDUCATION_ID
			FROM T_SKILL_EDUCATION_MAPPING SEM
			JOIN T_SKILL S ON S.SKILL_CODE = SEM.SKILL_CODE
				AND S.EXAM_CLASS_CODE = SEM.EXAM_CLASS_CODE
			JOIN T_HAVE_SKILL HS ON HS.SKILL_CODE = SEM.SKILL_CODE
				AND HS.EXAM_CLASS_CODE = SEM.EXAM_CLASS_CODE
				AND HS.USER_ID = #{userId}
			JOIN T_SKILL_PROGRESS_STATUS SPS ON SPS.SKILL_CODE = SEM.SKILL_CODE
				AND SPS.EXAM_CLASS_CODE = SEM.EXAM_CLASS_CODE
				AND SPS.USER_ID = HS.USER_ID
			WHERE S.IS_USE = 'Y'
				AND NOT HS.SKILL_PROGRESS_LEVEL_CODE = '1201'
				AND NOT (HS.SKILL_PROGRESS_LEVEL_CODE = '1202' AND SPS.EXAM_PROGRESS_STATUS_CODE = '1401')
			GROUP BY SEM.SKILL_EDUCATION_ID
		) JSEM ON JSEM.SKILL_EDUCATION_ID = SE.SKILL_EDUCATION_ID
		WHERE SE.IS_USE = 'Y'
		ORDER BY NEWID()
		OFFSET 0 ROW
		FETCH NEXT #{rows} ROW ONLY
	</select>
	
	<select id="selectEduMappingList" parameterType="map" resultType="com.iscreammedia.clic.front.domain.SkillEducationMappingDomain">
		SELECT		/*	MypageRepository.selectEduMappingList  스킬 교육 매핑 조회*/
			SEM.SKILL_EDUCATION_MAPPING_ID
			, SEM.SKILL_EDUCATION_ID
			, SEM.SKILL_CODE
			, SEM.EXAM_CLASS_CODE
			, S.SKILL_NAME_${language.code} AS SKILL_NAME
		FROM T_SKILL_EDUCATION_MAPPING SEM
		JOIN T_SKILL S ON S.SKILL_CODE = SEM.SKILL_CODE
			AND S.EXAM_CLASS_CODE = SEM.EXAM_CLASS_CODE
		JOIN T_SKILL_EDUCATION SE ON SE.SKILL_EDUCATION_ID = SEM.SKILL_EDUCATION_ID
		WHERE SE.IS_USE = 'Y'
			AND S.IS_USE = 'Y'
			AND SEM.SKILL_EDUCATION_ID = #{skillEducationId}
	</select>
	
	<select id="selectUser" parameterType="String" resultType="com.iscreammedia.clic.front.domain.MypageUserDomain">
		SELECT		/* MypageRepository.selectUser  유저 조회 */
			U.USER_ID
			, U.NAME
			, U.FIRSTNAME
			, J.JOB_NAME_${language.code} AS JOB_NAME
			, U.USER_IMAGE_PATH
			, CT.COUNTRY_CODE
		FROM T_USER U
		JOIN T_JOB_TABLE J ON J.JOB_ID = U.JOB_ID
		LEFT JOIN T_COUNTRY_TABLE CT ON CT.COUNTRY_CODE = U.COUNTRY_CODE
		WHERE U.USER_ID = #{userId}
	</select>
	
	<select id="selectSkillUser" parameterType="String" resultType="com.iscreammedia.clic.front.domain.UserDomain">
		SELECT		/* MypageRepository.selectSkillUser  유저 조회 */
			U.USER_ID
			, U.NAME
			, U.FIRSTNAME
			, J.JOB_NAME_${language.code} AS JOB_NAME
			, S.SKILL_NAME_${language.code} AS SKILL_NAME
			, U.USER_IMAGE_PATH
			, CT.COUNTRY_CODE
		FROM T_USER U
		JOIN T_JOB_TABLE J ON J.JOB_ID = U.JOB_ID
		LEFT JOIN T_COUNTRY_TABLE CT ON CT.COUNTRY_CODE = U.COUNTRY_CODE
		JOIN T_HAVE_SKILL HS ON HS.USER_ID = U.USER_ID
		JOIN T_SKILL S ON S.SKILL_CODE = HS.SKILL_CODE
			AND S.EXAM_CLASS_CODE = HS.EXAM_CLASS_CODE
		WHERE U.USER_ID = #{userId}
			AND S.SKILL_CODE = #{skillCode}
			AND S.EXAM_CLASS_CODE = #{examClassCode}
	</select>
	
</mapper>